{% extends 'blogs/base.html' %}

{% block title %}{{ post.title }} - åšå®¢{% endblock %}

{% block content %}
<article>
    <h2>{{ post.title }}</h2>
    <p class="post-meta">
        ä½œè€…ï¼š{{ post.owner.username }} | 
        å‘å¸ƒäºï¼š{{ post.date_added|date:"Y-m-d H:i" }} |
        ç‚¹èµæ•°ï¼š<span id="likes-count">{{ post.likes_count }}</span>
    </p>
    
    <div class="post-content">
        {{ post.content|linebreaks }}
    </div>
    
    <!-- ç‚¹èµæŒ‰é’® -->
    <div class="like-section">
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'blogs:toggle_like' post.id %}" id="like-form">
                {% csrf_token %}
                <button type="submit" class="like-btn {% if user_has_liked %}liked{% endif %}">
                    {% if user_has_liked %}
                        â¤ï¸ å·²ç‚¹èµ
                    {% else %}
                        ğŸ¤ ç‚¹èµ
                    {% endif %}
                </button>
            </form>
        {% else %}
            <p><a href="{% url 'accounts:login' %}">ç™»å½•</a>åå³å¯ç‚¹èµ</p>
        {% endif %}
    </div>
</article>

<!-- è¯„è®ºåŒºåŸŸ -->
<section class="comments-section">
    <h3>è¯„è®ºï¼ˆ{{ comments.count }}æ¡ï¼‰</h3>
    
    <!-- è¯„è®ºè¡¨å• -->
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'blogs:add_comment' post.id %}" class="comment-form">
        {% csrf_token %}
        <div class="form-group">
            {{ comment_form.content }}
        </div>
        <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
    </form>
    {% else %}
    <p>è¯·å…ˆ<a href="{% url 'accounts:login' %}">ç™»å½•</a>åå‘è¡¨è¯„è®º</p>
    {% endif %}
    
    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment">
            <div class="comment-header">
                <strong>{{ comment.author.username }}</strong>
                <span class="comment-time">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                
                {% if user == comment.author or user == post.owner %}
                <form method="post" action="{% url 'blogs:delete_comment' comment.id %}" 
                      class="delete-form" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ');">
                    {% csrf_token %}
                    <button type="submit" class="delete-btn">åˆ é™¤</button>
                </form>
                {% endif %}
            </div>
            <div class="comment-content">
                {{ comment.content|linebreaks }}
            </div>
        </div>
        {% empty %}
        <p class="no-comments">è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>
        {% endfor %}
    </div>
</section>

<style>
.like-btn {
    background: none;
    border: 2px solid #ff4757;
    color: #ff4757;
    padding: 8px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
}

.like-btn:hover {
    background: #ff4757;
    color: white;
}

.like-btn.liked {
    background: #ff4757;
    color: white;
}

.comment {
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f9f9f9;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}

.comment-time {
    color: #666;
    font-size: 14px;
}

.delete-form {
    display: inline;
}

.delete-btn {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 3px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

.no-comments {
    text-align: center;
    color: #666;
    padding: 30px;
    border: 1px dashed #ddd;
    border-radius: 8px;
}
</style>

<script>
// AJAXç‚¹èµåŠŸèƒ½
document.getElementById('like-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const button = form.querySelector('.like-btn');
    const likesCount = document.getElementById('likes-count');
    
    // å‘é€AJAXè¯·æ±‚
    fetch(form.action, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        // æ›´æ–°ç‚¹èµæ•°å’ŒæŒ‰é’®çŠ¶æ€
        likesCount.textContent = data.likes_count;
        
        if (data.liked) {
            button.innerHTML = 'â¤ï¸ å·²ç‚¹èµ';
            button.classList.add('liked');
        } else {
            button.innerHTML = 'ğŸ¤ ç‚¹èµ';
            button.classList.remove('liked');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // å¦‚æœAJAXå¤±è´¥ï¼Œå›é€€åˆ°è¡¨å•æäº¤
        form.submit();
    });
});
</script>
{% endblock %}